<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DC Foresight | Revenue & Pipeline Dashboard</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <style>
    body { background: #f8f9fa; }
    .kpi-card .value { font-size: 1.8rem; font-weight: 700; }
    .kpi-card .label { color: #6c757d; }
    .progress-height { height: 28px; }
    .dropzone {
      border: 2px dashed #ced4da; border-radius: 8px; padding: 1rem; text-align: center; cursor: pointer;
      background: #fff;
    }
    .dropzone:hover { background: #f1f3f5; }
    footer { color: #6c757d; font-size: .9rem; }
    .badge-muted { background-color: #e9ecef; color: #6c757d; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h1 class="h3 mb-0">Revenue & Pipeline Dashboard</h1>
        <div id="subtitle" class="text-muted"></div>
      </div>
      <div class="d-flex gap-2">
        <label class="btn btn-outline-secondary mb-0">
          <input type="file" id="fileInput" accept=".json,application/json" hidden>
          Upload data.json
        </label>
        <button class="btn btn-primary" id="refreshBtn">Reload</button>
      </div>
    </div>

    <!-- KPI Row -->
    <div class="row g-3" id="kpis">
      <div class="col-12 col-md-6 col-lg-3">
        <div class="card kpi-card shadow-sm">
          <div class="card-body">
            <div class="label">Net Wealth Sales (YTD)</div>
            <div class="value" id="kpi-net-wealth">—</div>
            <div class="small text-muted" id="kpi-net-wealth-change"></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-3">
        <div class="card kpi-card shadow-sm">
          <div class="card-body">
            <div class="label">Leads (New / Converted MTD)</div>
            <div class="value"><span id="kpi-leads-new">—</span> / <span id="kpi-leads-converted">—</span></div>
            <div class="small text-muted" id="kpi-leads-rate"></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-3">
        <div class="card kpi-card shadow-sm">
          <div class="card-body">
            <div class="label">Insurance Premium (MTD)</div>
            <div class="value" id="kpi-ins-premium">—</div>
            <div class="small text-muted" id="kpi-ins-trend"></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-3">
        <div class="card kpi-card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div class="label">NAFYC Goal</div>
              <span class="badge badge-muted" id="nafyc-badge">annual</span>
            </div>
            <div class="progress progress-height my-2">
              <div id="nafyc-progress" class="progress-bar" role="progressbar" style="width:0%">0%</div>
            </div>
            <div class="small text-muted"><span id="nafyc-to-date">—</span> / <span id="nafyc-goal">—</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mt-1">
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h2 class="h6 mb-0">Net Wealth Sales (Monthly)</h2>
              <span class="badge bg-light text-dark" id="kpi-net-wealth-last"></span>
            </div>
            <canvas id="wealthChart" height="160"></canvas>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h2 class="h6 mb-0">Leads — New vs Converted</h2>
              <span class="badge bg-light text-dark" id="kpi-leads-last"></span>
            </div>
            <canvas id="leadsChart" height="160"></canvas>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h2 class="h6 mb-0">Insurance Premium (Monthly)</h2>
              <span class="badge bg-light text-dark" id="kpi-ins-last"></span>
            </div>
            <canvas id="insChart" height="160"></canvas>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h2 class="h6 mb-0">Opportunity Funnel</h2>
              <span class="badge bg-light text-dark" id="kpi-funnel-last">snapshot</span>
            </div>
            <canvas id="funnelChart" height="160"></canvas>
          </div>
        </div>
      </div>
    </div>

    <footer class="mt-4 text-center">
      <div class="mb-1">
        <span id="footer-co"></span> • Data refreshed <span id="footer-updated"></span>
      </div>
      <div class="small">
        Replace <code>data.json</code> to update, or click “Upload data.json” to preview updates instantly.
      </div>
    </footer>
  </div>

  <script>
    const currencyFmt = (n, currency='CAD') => new Intl.NumberFormat('en-CA', {style:'currency', currency}).format(n);
    const pctFmt = (n) => (n*100).toFixed(0) + '%';

    let DASH = null;

    async function loadData(file) {
      if (file) {
        return JSON.parse(await file.text());
      }
      const res = await fetch('data.json?_=' + Date.now());
      return await res.json();
    }

    function last(arr) { return arr[arr.length - 1]; }
    function sum(arr) { return arr.reduce((a,b)=>a+b,0); }

    function renderKpis(data) {
      const monthly = data.monthly.map(m => ({...m, 
        month: new Date(m.month),
        net_wealth_sales: +m.net_wealth_sales,
        leads_new: +m.leads_new,
        leads_converted: +m.leads_converted,
        insurance_premium: +m.insurance_premium,
        nafyc_to_date: +m.nafyc_to_date
      }));
      const ytdWealth = monthly.length ? monthly[monthly.length-1].net_wealth_sales : 0;
      const mtd = monthly.length ? monthly[monthly.length-1] : null;
      const prev = monthly.length>1 ? monthly[monthly.length-2] : null;

      // Title
      document.getElementById('subtitle').textContent = (data.meta.company || '') + ' · ' + (new Date()).toLocaleDateString();

      // KPIs
      document.getElementById('kpi-net-wealth').textContent = currencyFmt(ytdWealth, data.meta.currency || 'CAD');
      if (prev) {
        const chg = (ytdWealth - prev.net_wealth_sales) / Math.max(prev.net_wealth_sales,1);
        document.getElementById('kpi-net-wealth-change').textContent = (chg>=0? '▲ ':'▼ ') + (Math.abs(chg)*100).toFixed(1)+'% vs prior';
      } else {
        document.getElementById('kpi-net-wealth-change').textContent = '—';
      }

      document.getElementById('kpi-leads-new').textContent = mtd? mtd.leads_new : '—';
      document.getElementById('kpi-leads-converted').textContent = mtd? mtd.leads_converted : '—';
      if (mtd) {
        const rate = mtd.leads_new ? (mtd.leads_converted / mtd.leads_new) : 0;
        document.getElementById('kpi-leads-rate').textContent = 'Conv. rate: ' + (rate*100).toFixed(0) + '%';
      } else {
        document.getElementById('kpi-leads-rate').textContent = '—';
      }

      document.getElementById('kpi-ins-premium').textContent = mtd? currencyFmt(mtd.insurance_premium, data.meta.currency || 'CAD'): '—';
      if (prev && mtd) {
        const ichg = (mtd.insurance_premium - prev.insurance_premium) / Math.max(prev.insurance_premium,1);
        document.getElementById('kpi-ins-trend').textContent = (ichg>=0? '▲ ':'▼ ') + (Math.abs(ichg)*100).toFixed(1)+'% vs prior';
      } else {
        document.getElementById('kpi-ins-trend').textContent = '—';
      }

      const goal = data.meta.nafyc_goal || 0;
      const toDate = mtd ? mtd.nafyc_to_date : 0;
      const pct = goal? Math.min(100, Math.round(100*toDate/goal)) : 0;
      document.getElementById('nafyc-progress').style.width = pct + '%';
      document.getElementById('nafyc-progress').textContent = pct + '%';
      document.getElementById('nafyc-goal').textContent = currencyFmt(goal, data.meta.currency || 'CAD');
      document.getElementById('nafyc-to-date').textContent = currencyFmt(toDate, data.meta.currency || 'CAD');
      document.getElementById('nafyc-badge').textContent = 'annual';
      document.getElementById('footer-co').textContent = data.meta.company || '';
      document.getElementById('footer-updated').textContent = (data.meta.last_updated || '').toString();
      document.getElementById('kpi-net-wealth-last').textContent = monthly.length? monthly[monthly.length-1].month.toLocaleDateString(undefined, {month:'short', year:'numeric'}):'';
      document.getElementById('kpi-leads-last').textContent = document.getElementById('kpi-net-wealth-last').textContent;
      document.getElementById('kpi-ins-last').textContent = document.getElementById('kpi-net-wealth-last').textContent;

      return monthly;
    }

    let wealthChart, leadsChart, insChart, funnelChart;

    function renderCharts(data, monthly) {
      const labels = monthly.map(m => m.month);
      const wealth = monthly.map(m => m.net_wealth_sales);
      const leadsNew = monthly.map(m => m.leads_new);
      const leadsConv = monthly.map(m => m.leads_converted);
      const premium = monthly.map(m => m.insurance_premium);

      // Destroy if exist
      [wealthChart, leadsChart, insChart, funnelChart].forEach(ch => ch && ch.destroy());

      wealthChart = new Chart(document.getElementById('wealthChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [{ label: 'Net Wealth Sales', data: wealth, borderWidth: 2, tension: .25, fill: false }]
        },
        options: {
          responsive: true,
          parsing: false,
          scales: {
            x: { type: 'time', time: { unit: 'month' } },
            y: { ticks: { callback: v => currencyFmt(v) } }
          },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: ctx => currencyFmt(ctx.parsed.y) } }
          }
        }
      });

      leadsChart = new Chart(document.getElementById('leadsChart'), {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'New', data: leadsNew },
            { label: 'Converted', data: leadsConv }
          ]
        },
        options: {
          responsive: true,
          parsing: false,
          scales: { x: { type: 'time', time: { unit: 'month' } } },
          plugins: { legend: { position: 'top' } }
        }
      });

      insChart = new Chart(document.getElementById('insChart'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: 'Premium', data: premium }]
        },
        options: {
          responsive: true,
          parsing: false,
          scales: {
            x: { type: 'time', time: { unit: 'month' } },
            y: { ticks: { callback: v => currencyFmt(v) } }
          },
          plugins: { legend: { display: false } }
        }
      });

      const funnelStages = Object.keys(data.funnel);
      const funnelValues = Object.values(data.funnel);
      funnelChart = new Chart(document.getElementById('funnelChart'), {
        type: 'bar',
        data: {
          labels: funnelStages,
          datasets: [{ label: 'Count', data: funnelValues }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { beginAtZero: true }
          }
        }
      });
    }

    async function boot(file) {
      DASH = await loadData(file);
      const monthly = renderKpis(DASH);
      renderCharts(DASH, monthly);
    }

    // Upload support
    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file) boot(file);
    });
    document.getElementById('refreshBtn').addEventListener('click', () => boot());
    // Init
    boot();
  </script>
</body>
</html>
